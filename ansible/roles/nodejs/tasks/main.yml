---
- name: Install Node.js & NPM
  apt:
    name: ["nodejs", "npm"]
    state: present

- name: Create App Directory
  file: path=/opt/myapp state=directory

- name: Copy Application Code
  copy:
    src: ../../../app/server.js  # We will create this file right after
    dest: /opt/myapp/server.js

- name: Create Systemd Service for Node
  copy:
    dest: /etc/systemd/system/myapp.service
    content: |
      [Unit]
      Description=My Portfolio App
      After=network.target

      [Service]
      ExecStart=/usr/bin/node /opt/myapp/server.js
      Restart=always
      User=ubuntu
      Environment=PORT=3000

      [Install]
      WantedBy=multi-user.target
  notify: Restart App

- name: Start App Service
  service: name=myapp state=started enabled=yes
# ... previous tasks ...

- name: Copy App
  copy: src=../../../app/ dest=/opt/myapp/

- name: Install Dependencies
  npm: path=/opt/myapp

- name: Create Service
  copy:
    dest: /etc/systemd/system/myapp.service
    content: |
      [Unit]
      Description=Node App
      [Service]
      ExecStart=/usr/bin/node /opt/myapp/server.js
      Restart=always
      User=ubuntu
      EnvironmentFile=/opt/myapp/.env
      [Install]
      WantedBy=multi-user.target